//@author Fred Brooker <git@gscloud.cz>
"use strict";

var version = "{{ VERSION }}";
var core = [
  {{#sitemap}}"/{{ . }}", {{/sitemap}}
  {{#swpreload}}"{{ . }}", {{/swpreload}}
  {{#swpreload_cdn}}"{{ cdn }}{{ . }}", {{/swpreload_cdn}}
  "{{ cdn }}/img/favicon-16.webp",
  "{{ cdn }}/img/favicon-128.webp",
  "{{ cdn }}/img/favicon-180.webp",
  "{{ cdn }}/img/favicon-192.png",
  "{{ cdn }}/img/favicon-192.webp",
  "{{ cdn }}/img/favicon-512.png",
  "{{ cdn }}/img/favicon-512.webp",
  "{{ cdn }}/img/logo.webp",
  "https://cdn.gscloud.cz/css/materialize.min.css",
  "https://cdn.gscloud.cz/img/LASAGNA_logo.webp",
  "https://cdn.gscloud.cz/img/g.png",
  "https://cdn.gscloud.cz/img/gsc.png",
  "https://cdn.gscloud.cz/img/materialize.svg",
  "https://cdn.gscloud.cz/img/pwa.png",
  "https://cdn.gscloud.cz/js/jquery.min.js",
  "https://cdn.gscloud.cz/webfonts/materialicons-regular.woff2",
];

self.addEventListener("install", function (event) {
  event.waitUntil(
    caches.open(version + "_core")
    .then(function (cache) {
      return cache.addAll(core);
    })
    .then(self.skipWaiting())
  );
});

self.addEventListener("fetch", function (event) {
  if (!(event.request.url.indexOf('http') === 0)) return;
  if (event.request.method !== "GET") return;
  if (event.request.url.indexOf("/logout") !== -1) {
    console.log("Skip cache for %s", event.request.url);
    return;
  }
  if (event.request.url.indexOf("/login") !== -1) {
    console.log("Skip cache for %s", event.request.url);
    return;
  }
  if (event.request.url.indexOf("?nonce") !== -1) {
    console.log("Skip cache for %s", event.request.url);
    return;
  }
  if (event.request.url.indexOf("/exportHTML/") !== -1) {
    console.log("Skip cache for  %s", event.request.url);
    return;
  }
  if (event.request.url.indexOf("/embed/") !== -1) {
    console.log("Skip cache for  %s", event.request.url);
    return;
  }
  if (event.request.url.indexOf("/print/") !== -1) {
    console.log("Skip cache for  %s", event.request.url);
    return;
  }

  event.respondWith(
    caches.match(event.request)
    .then(function (cached) {
      var networked = fetch(event.request)
        .then(fetchedFromNetwork, unableToResolve)
        .catch(unableToResolve);
      return cached || networked;

      function fetchedFromNetwork (response) {
        var cacheCopy = response.clone();
        caches.open(version + "_pages")
          .then(function add(cache) {
            return cache.put(event.request, cacheCopy);
          })
          .then(function () {
          });
        return response;
      }

      function unableToResolve() {
        return new Response('<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1.0"><h2 style="text-align:center">ðŸ“µ No connectivity!</h2><h4 style="text-align:center"><a href="javascript:location.reload();">click to reload â†»</a></h4>', {
          status: 503,
          statusText: "Service Unavailable",
          headers: new Headers({
            "Content-Type": "text/html"
          })
        });
      }

    })
  );

});

self.addEventListener("activate", function (event) {
  event.waitUntil(
    caches
    .keys()
    .then(function (keys) {
      return Promise.all(
        keys
        .filter(function (key) {
          return !key.startsWith(version);
        })
        .map(function (key) {
          return caches.delete(key);
        })
      );
    })
    .then(function () {
      console.log("Service Worker active");
    })
  );
});
